import create_train_test_set as ctts
import train
import os
import time
import all_printing as pr

choices = ["0", "1", "2", "3", "4"]

def start_training(files_benign, train_benign, files_malware, train_malware):
    with open("base.txt", "w") as f:
        for item in train_benign:
            f.write(files_benign[item] + "\n")
    with open("input.txt", "w") as f:
        for item in train_malware:
            f.write(files_malware[item] + "\n")
    train.model()
    print("\n..................................................................................................................\n")

def read_executable(t):
    cat = t.split("_")[2].split("/")[0]
    name = t.split("_")[2].split("/")[1].split(".")[0]
    if cat == "benign":
        path = "./Offline/benign_executables/"
    else:
        path = "./Malware_Program/"
    executable = path + name
    return executable

def start_testing(test_benign, files_benign, test_malware, files_malware):
    with open("input.txt", "w") as f:
        for item in test_benign:
            f.write(files_benign[item] + "\n")
        for item in test_malware:
            f.write(files_malware[item] + "\n")
    with open("input.txt", "r") as tar:
        target = tar.readlines()
    case = 1
    for t in target:
        execute = read_executable(t)
        with open("test_input.txt", "w") as f:
            f.write(t)
        print('\033[96m' + "TEST CASE: "+str(case)+"\n" + '\033[0m')
        os.system("./scheduler test.py "+execute)
        print(".................................................................")
        case += 1
        time.sleep(2)
    print("\n..................................................................................................................\n")

def start_testing_single(test_benign, files_benign):
    path_to_dump_file = "./Offline/hello_world.txt"
    execute = "./Offline/benign_executables/hello_world"
    with open("test_input.txt", "w") as f:
        f.write(path_to_dump_file)
    print('\033[96m' + "TEST CASE: Hello World\n" + '\033[0m')
    os.system("./scheduler test.py "+execute)
    print(".................................................................")

def main():
    con = True
    dataset = False
    trained = False
    while con:
        pr.print_menu()
        ch = raw_input("Enter a choice : ")
        if ch == "":
            print('\033[96m' + "Nothing Entered.." + '\033[0m'+"\n")
            continue
        if ch not in choices:
            print('\033[96m' + "Invalid Choice..!!" + '\033[0m'+"\n")
        if ch == "0":
            con = False
        if ch == "1":
            files_benign, train_benign, test_benign, files_malware, train_malware, test_malware = ctts.create()
            pr.print_train_test_set(files_benign, train_benign, test_benign, files_malware, train_malware, test_malware)
            dataset = True
        if ch == "2":
            if dataset:
                start_training(files_benign, train_benign, files_malware, train_malware)
                trained = True
            else:
                print('\033[96m' + "Dataset Not Created..!!" + '\033[0m'+"\n")
        if ch == "3":
            if trained:
                start_testing(test_benign, files_benign, test_malware, files_malware)
            else:
                print('\033[96m' + "Training Not Performed!!" + '\033[0m'+"\n")
        if ch == "4":
            if trained:
                start_testing_single(test_benign, files_benign)
            else:
                print('\033[96m' + "Training Not Performed..!!" + '\033[0m'+"\n")
            
if __name__ == "__main__":
    main()